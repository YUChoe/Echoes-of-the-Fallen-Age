# 고급 전투 시스템 요구사항

## 개요
현재 1:1 전투 시스템을 확장하여 멀티 타겟 전투와 선공형 몬스터 시스템을 구현합니다.

## 사용자 스토리

### US-1: 멀티 타겟 전투 시스템 ✅ 완료
**As a** 플레이어
**I want to** 전투 중에도 다른 몬스터를 공격할 수 있기를
**So that** 더 전략적이고 역동적인 전투를 경험할 수 있다

#### 인수 기준:
- [x] 플레이어가 전투 중일 때 다른 몬스터를 공격할 수 있음
- [x] 기존 전투는 자동으로 종료되고 새로운 전투가 시작됨
- [x] 전투 전환 시 적절한 메시지가 표시됨
- [x] 전투 UI가 새로운 타겟에 맞게 업데이트됨
- [x] 여러 몬스터와 동시 전투 가능 (1 vs N)

### US-2: 선공형 몬스터 시스템 🔄 진행 중
**As a** 플레이어
**I want** 선공형 몬스터가 나를 먼저 공격할 수 있기를
**So that** 더 긴장감 있고 현실적인 게임 경험을 할 수 있다

#### 인수 기준:
- [ ] 선공형 몬스터가 플레이어 감지 시 자동으로 전투 시작
- [ ] 플레이어가 방에 입장할 때 선공형 몬스터 즉시 반응
- [ ] 플레이어가 전투 중이 아닐 때 몬스터가 먼저 공격
- [ ] 플레이어가 전투 중일 때는 기존 전투에 참여하지 않음
- [ ] 몬스터 타입별 어그로 범위 설정
- [ ] 선공 메시지와 일반 전투 메시지 구분

### US-3: 플레이어 이동 시 선공 시스템
**As a** 플레이어
**I want** 새로운 방에 입장할 때 선공형 몬스터가 즉시 반응하기를
**So that** 방 이동이 전략적 요소가 된다

#### 인수 기준:
- [ ] goto 명령어로 방 이동 시 선공형 몬스터 감지
- [ ] move_player_to_room 메서드에 선공 체크 로직 통합
- [ ] 방 입장 즉시 선공형 몬스터 공격 시작
- [ ] 여러 선공형 몬스터가 있을 경우 우선순위 처리
- [ ] 선공 알림 메시지 표시

### US-4: 전투 상태 관리 개선
**As a** 개발자
**I want** 복잡한 전투 상황을 효율적으로 관리하기를
**So that** 시스템이 안정적으로 작동한다

#### 인수 기준:
- [x] 전투 참여자 목록 관리 (1:N, N:1, N:N)
- [x] 전투 우선순위 시스템
- [x] 전투 상태 동기화
- [x] 전투 종료 조건 개선
- [x] 메모리 누수 방지

## 기술적 요구사항

### 서버 측 개선
1. **CombatSystem 확장** ✅ 완료
   - 멀티 타겟 전투 지원
   - 전투 전환 로직
   - 선공형 몬스터 AI

2. **MonsterManager 개선** 🔄 진행 중
   - 몬스터 어그로 시스템
   - 자동 공격 스케줄러
   - 플레이어 감지 로직

3. **PlayerMovementManager 통합** 🔄 진행 중
   - move_player_to_room 메서드에 선공 체크 추가
   - 방 입장 시 즉시 선공 처리
   - GotoCommand와 연동

4. **전투 메시지 타입 확장** ✅ 완료
   - `combat_switch`: 전투 대상 변경
   - `monster_aggro`: 몬스터 선공
   - `multi_combat_status`: 다중 전투 상태

### 클라이언트 측 개선 ✅ 완료
1. **전투 UI 확장**
   - 다중 타겟 표시
   - 전투 전환 애니메이션
   - 선공 알림 UI

2. **메시지 핸들러 확장**
   - 새로운 전투 메시지 타입 처리
   - 전투 상태 전환 처리

## 우선순위
1. **High**: 멀티 타겟 전투 시스템 (US-1) ✅ 완료
2. **High**: 선공형 몬스터 시스템 (US-2) 🔄 진행 중
3. **High**: 플레이어 이동 시 선공 시스템 (US-3) 🔄 진행 중
4. **Medium**: 전투 상태 관리 개선 (US-4) ✅ 완료

## 제약사항
- 기존 1:1 전투 시스템과 호환성 유지
- 성능 최적화 (다중 전투 시 서버 부하 고려)
- 클라이언트 UI 복잡도 관리

## 성공 기준
- [x] 플레이어가 전투 중 다른 몬스터 공격 가능
- [ ] 선공형 몬스터가 자동으로 플레이어 공격
- [ ] 방 이동 시 즉시 선공 반응
- [x] 전투 전환이 부드럽고 직관적
- [x] 시스템 안정성 유지

## 현재 진행 상황
- ✅ **Phase 1 완료**: 멀티 타겟 전투 시스템 구현
- 🔄 **Phase 2 진행 중**: 선공형 몬스터 시스템 구현
  - MonsterManager에 어그로 시스템 추가 중
  - PlayerMovementManager 통합 작업 중
  - move_player_to_room 메서드에 선공 체크 로직 추가 예정