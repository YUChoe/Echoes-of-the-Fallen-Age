# 고급 전투 시스템 구현 작업

## 작업 개요

현재 1:1 전투 시스템을 확장하여 멀티 타겟 전투와 선공형 몬스터 시스템을 구현합니다.

## Phase 1: 멀티 타겟 전투 시스템 ✅ 완료

### 1. 전투 시스템 아키텍처 분석 및 설계 ✅ 완료

**상태**: completed
**설명**: 현재 전투 시스템 구조를 분석하고 멀티 타겟 지원을 위한 설계 수립

- [x] 현재 CombatSystem과 AutoCombat 클래스 분석
- [x] 멀티 타겟 전투를 위한 데이터 구조 설계
- [x] 전투 전환 로직 설계
- [x] 성능 및 메모리 사용량 고려사항 정리

### 2. CombatSystem 멀티 타겟 지원 확장 ✅ 완료

**상태**: completed
**설명**: 기존 CombatSystem을 확장하여 여러 몬스터와의 전투 지원

- [x] 전투 참여자 목록 관리 구조 추가
- [x] 전투 전환 메서드 구현 (switch_combat_target)
- [x] 다중 전투 상태 관리 로직
- [x] 전투 종료 조건 개선

### 3. 전투 명령어 개선 ✅ 완료

**상태**: completed
**설명**: attack 명령어가 전투 중에도 다른 몬스터를 공격할 수 있도록 개선

- [x] AttackCommand 로직 수정
- [x] 전투 중 타겟 변경 처리
- [x] 적절한 메시지 및 알림 추가
- [x] 에러 처리 개선

### 4. 전투 메시지 타입 확장 ✅ 완료

**상태**: completed
**설명**: 멀티 타겟 전투를 위한 새로운 메시지 타입 추가

- [x] `combat_switch` 메시지 타입 정의
- [x] `monster_aggro` 메시지 타입 정의
- [x] 기존 전투 메시지에 타겟 정보 추가
- [x] 메시지 브로드캐스트 로직 개선

## Phase 2: 선공형 몬스터 시스템 🔄 진행 중

### 5. 몬스터 AI 및 어그로 시스템 구현 🔄 진행 중

**상태**: in_progress
**설명**: 몬스터가 플레이어를 감지하고 자동으로 공격하는 시스템 구현

- [x] 몬스터 어그로 범위 시스템
- [x] 플레이어 감지 로직
- [x] 선공형 몬스터 타입 정의
- [ ] 자동 공격 트리거 구현

### 6. MonsterManager 확장 🔄 진행 중

**상태**: in_progress
**설명**: 몬스터 관리 시스템을 확장하여 능동적 행동 지원

- [x] 몬스터 행동 스케줄러 추가
- [x] 플레이어 위치 추적 시스템
- [x] 어그로 상태 관리
- [ ] 몬스터 간 상호작용 로직

### 7. PlayerMovementManager 통합 🔄 진행 중

**상태**: in_progress
**설명**: 플레이어 이동 시 선공형 몬스터 즉시 반응 시스템

- [x] PlayerMovementManager 클래스 위치 확인

- [x] move_player_to_room 메서드에 선공 체크 로직 추가

- [x] GotoCommand와 연동

- [x] 방 입장 시 즉시 선공 처리

### 8. 선공 전투 시작 로직 🔄 진행 중

**상태**: in_progress
**설명**: 몬스터가 먼저 전투를 시작하는 로직 구현

- [x] 몬스터 주도 전투 시작 메서드
- [x] 플레이어 전투 상태 확인
- [x] 선공 메시지 및 알림
- [x] 기존 전투와의 통합 처리

## Phase 3: 클라이언트 UI 개선 ✅ 완료

### 9. 전투 UI 멀티 타겟 지원 ✅ 완료

**상태**: completed
**설명**: 클라이언트 전투 UI를 확장하여 다중 타겟 표시

- [x] 다중 몬스터 HP 바 표시
- [x] 현재 타겟 하이라이트
- [x] 전투 전환 애니메이션
- [x] 타겟 선택 UI (선택사항)

### 10. 메시지 핸들러 확장 ✅ 완료

**상태**: completed
**설명**: 새로운 전투 메시지 타입들을 처리하는 핸들러 추가

- [x] `combat_switch` 메시지 핸들러
- [x] `monster_aggro` 메시지 핸들러
- [x] `multi_combat_status` 메시지 핸들러
- [x] 선공 알림 UI 표시

### 11. 전투 상태 표시 개선 ✅ 완료


**상태**: completed
**설명**: 복잡한 전투 상황을 직관적으로 표시

- [x] 전투 참여자 목록 표시
- [x] 전투 우선순위 표시
- [x] 선공/후공 상태 표시
- [x] 전투 로그 개선

## Phase 4: 테스트 및 최적화 📋 대기 중

### 12. 통합 테스트 📋 대기 중

**상태**: not_started
**설명**: 전체 시스템의 통합 테스트 및 버그 수정

- [x] 멀티 타겟 전투 시나리오 테스트

- [x] 선공형 몬스터 동작 테스트

- [x] 전투 전환 시나리오 테스트

- [x] 에지 케이스 처리 확인

### 13. 성능 최적화 📋 대기 중

**상태**: not_started
**설명**: 다중 전투 시스템의 성능 최적화

- [ ] 메모리 사용량 최적화
- [ ] 전투 메시지 브로드캐스트 최적화
- [ ] 데이터베이스 쿼리 최적화
- [ ] 클라이언트 렌더링 최적화

## 현재 작업 중인 항목

### 🎯 다음 작업: Task 7 - PlayerMovementManager 통합

**목표**: GotoCommand의 move_player_to_room 메서드에 선공 시스템 추가

**세부 작업**:

1. PlayerMovementManager 클래스 위치 확인
2. move_player_to_room 메서드 분석
3. 선공 체크 로직 추가
4. 방 입장 시 즉시 선공 처리 구현

**예상 구현**:

```python
async def move_player_to_room(self, player, target_room_id):
    # 기존 이동 로직
    # ...

    # 선공형 몬스터 체크 및 즉시 공격
    await self._check_aggressive_monsters_on_entry(player, target_room_id)
```

## 우선순위

1. **Critical**: Task 7 (PlayerMovementManager 통합)
2. **High**: Task 8 (선공 전투 시작 로직 완성)
3. **Medium**: Task 12-13 (테스트 및 최적화)

## 예상 일정

- Task 7: 1-2시간
- Task 8: 30분-1시간
- Task 12-13: 1-2시간

## 의존성

- 현재 실시간 전투 UI 시스템 완료 ✅
- MessageHandler 전투 메시지 라우팅 정상 작동 ✅
- MonsterManager 어그로 시스템 구현 🔄 진행 중
