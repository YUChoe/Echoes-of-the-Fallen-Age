# 전투 명중률 시스템 설명

## 개요
Python MUD 엔진은 D&D 5e 기반의 전투 시스템을 사용합니다.
명중률은 공격자의 **공격 굴림(Attack Roll)**과 방어자의 **AC(Armor Class)**를 비교하여 결정됩니다.

## 명중률 계산 방식

### 1. 공격 굴림 (Attack Roll)
```
공격 굴림 = d20 + 공격 보너스
```

- **d20**: 1~20 사이의 랜덤 값
- **공격 보너스**: 능력치 보정치 + 숙련도 보너스

### 2. 명중 판정
```
명중 성공 = 공격 굴림 >= 대상 AC
```

### 3. 크리티컬 히트
- d20 굴림이 **20**이면 자동 명중 + 데미지 2배
- d20 굴림이 **1**이면 자동 빗나감 (공격 굴림 0으로 처리)

## 능력치 기반 계산

### 플레이어 능력치 (PlayerStats)
플레이어는 D&D 5e 기반 6가지 1차 능력치를 가집니다:

| 능력치 | 영문 | 영향 |
|--------|------|------|
| 힘 (STR) | Strength | 물리 공격력, 소지 무게 |
| 민첩 (DEX) | Dexterity | AC, 명중률, 선공 순서 |
| 체력 (CON) | Constitution | HP, 방어력 |
| 지능 (INT) | Intelligence | 마법 공격력, MP |
| 지혜 (WIS) | Wisdom | 마법 방어력, MP 회복 |
| 매력 (CHA) | Charisma | NPC 상호작용, 거래 |

#### 공격 보너스 계산 (플레이어)
```python
# 힘 보정치 계산
str_modifier = (strength - 10) // 2

# 숙련도 보너스 (레벨 기반)
proficiency = level // 4

# 공격 보너스
attack_bonus = str_modifier + proficiency
```

**예시**: 힘 14, 레벨 5인 플레이어
- 힘 보정치: (14 - 10) // 2 = +2
- 숙련도: 5 // 4 = +1
- 공격 보너스: +3

#### AC 계산 (플레이어)
```python
# 민첩 보정치
dex_modifier = (dexterity - 10) // 2

# AC (방어도)
armor_class = 10 + dex_modifier + 장비_보너스
```

**예시**: 민첩 16인 플레이어
- 민첩 보정치: (16 - 10) // 2 = +3
- 기본 AC: 10 + 3 = 13

### 몬스터 능력치 (MonsterStats)
몬스터도 플레이어와 동일한 D&D 기반 능력치 체계를 사용합니다.

#### 작은 쥐 예시
```python
MonsterStats(
    strength=6,      # 힘 6 (매우 약함)
    dexterity=16,    # 민첩 16 (빠름)
    constitution=8,  # 체력 8 (약함)
    intelligence=2,  # 지능 2 (동물)
    wisdom=10,       # 지혜 10 (보통)
    charisma=4,      # 매력 4 (낮음)
    level=1          # 레벨 1
)
```

#### 공격 보너스 계산 (몬스터)
```python
# 힘 보정치
str_modifier = (strength - 10) // 2

# 숙련도 보너스
proficiency = level // 4

# 공격 보너스
attack_bonus = str_modifier + proficiency
```

**작은 쥐 예시**:
- 힘 보정치: (6 - 10) // 2 = -2
- 숙련도: 1 // 4 = 0
- 공격 보너스: -2

#### AC 계산 (몬스터)
```python
# 민첩 보정치
dex_modifier = (dexterity - 10) // 2

# AC
armor_class = 10 + dex_modifier
```

**작은 쥐 예시**:
- 민첩 보정치: (16 - 10) // 2 = +3
- AC: 10 + 3 = 13

## 명중률 실제 계산 예시

### 예시 1: 플레이어가 작은 쥐 공격
- **플레이어**: 힘 14, 레벨 5 → 공격 보너스 +3
- **작은 쥐**: AC 13

```
공격 굴림 = d20 + 3
명중 조건 = 공격 굴림 >= 13

d20 결과별 명중 여부:
- 1~9: 빗나감 (1+3=4 ~ 9+3=12 < 13)
- 10~19: 명중 (10+3=13 ~ 19+3=22 >= 13)
- 20: 크리티컬 히트 (자동 명중 + 데미지 2배)

명중 확률: 11/20 = 55%
```

### 예시 2: 작은 쥐가 플레이어 공격
- **작은 쥐**: 힘 6, 레벨 1 → 공격 보너스 -2
- **플레이어**: 민첩 10 → AC 10

```
공격 굴림 = d20 - 2
명중 조건 = 공격 굴림 >= 10

d20 결과별 명중 여부:
- 1: 자동 빗나감 (공격 굴림 0)
- 2~11: 빗나감 (2-2=0 ~ 11-2=9 < 10)
- 12~19: 명중 (12-2=10 ~ 19-2=17 >= 10)
- 20: 크리티컬 히트

명중 확률: 9/20 = 45%
```

## 명중률에 영향을 주는 요소

### 1. 민첩 (Dexterity)
- **높은 민첩**: AC 증가 → 맞기 어려움
- **작은 쥐**: 민첩 16 → AC 13 (맞추기 어려움)

### 2. 힘 (Strength)
- **높은 힘**: 공격 보너스 증가 → 명중률 증가
- **작은 쥐**: 힘 6 → 공격 보너스 -2 (명중률 낮음)

### 3. 레벨
- **높은 레벨**: 숙련도 보너스 증가 → 공격 보너스 증가
- 레벨 1~3: 숙련도 +0
- 레벨 4~7: 숙련도 +1
- 레벨 8~11: 숙련도 +2

### 4. 장비
- 무기: 공격 보너스 추가
- 방어구: AC 증가

## 전투 시스템 흐름

```
1. 전투 시작
   ↓
2. 선공 순서 결정 (민첩 기반)
   ↓
3. 턴 진행
   ├─ 공격자: d20 + 공격보너스 굴림
   ├─ 방어자: AC와 비교
   └─ 명중 판정
      ├─ 명중: 데미지 계산 및 적용
      └─ 빗나감: 데미지 없음
   ↓
4. 다음 턴 또는 전투 종료
```

## 코드 구현 위치

### 1. 능력치 정의
- **파일**: `src/mud_engine/game/stats.py`
- **클래스**: `PlayerStats`, `StatType`

### 2. 몬스터 능력치
- **파일**: `src/mud_engine/game/monster.py`
- **클래스**: `MonsterStats`

### 3. 전투 엔진
- **파일**: `src/mud_engine/game/dnd_combat.py`
- **클래스**: `DnDCombatEngine`
- **주요 메서드**:
  - `roll_d20()`: d20 굴림
  - `make_attack_roll()`: 공격 굴림 (d20 + 보너스)
  - `check_hit()`: 명중 판정

### 4. 전투 핸들러
- **파일**: `src/mud_engine/game/combat_handler.py`
- **클래스**: `CombatHandler`
- **주요 메서드**:
  - `_execute_attack()`: 공격 실행
  - `_calculate_attack_bonus()`: 공격 보너스 계산

### 5. 전투 관리
- **파일**: `src/mud_engine/game/combat.py`
- **클래스**: `CombatManager`, `Combatant`

## 밸런싱 가이드

### 약한 몬스터 (작은 쥐)
```python
strength=6       # 공격력 약함
dexterity=16     # 맞추기 어려움
constitution=8   # HP 낮음
level=1
```
- AC 13 (높음) → 플레이어가 맞추기 어려움
- 공격 보너스 -2 (낮음) → 플레이어를 맞추기 어려움
- HP 31 (낮음) → 빨리 죽음

### 균형잡힌 몬스터
```python
strength=12      # 보통 공격력
dexterity=12     # 보통 AC
constitution=14  # 보통 HP
level=3
```
- AC 11 (보통)
- 공격 보너스 +1 (보통)
- HP 약 50

### 강한 몬스터
```python
strength=18      # 높은 공격력
dexterity=10     # 낮은 AC (맞추기 쉬움)
constitution=18  # 높은 HP
level=5
```
- AC 10 (낮음) → 맞추기 쉬움
- 공격 보너스 +5 (높음) → 플레이어를 잘 맞춤
- HP 약 100

## 요약

1. **명중률은 d20 + 공격보너스 vs AC로 결정**
2. **공격보너스 = 힘 보정치 + 숙련도**
3. **AC = 10 + 민첩 보정치 + 장비**
4. **몬스터도 플레이어와 동일한 능력치 체계 사용**
5. **작은 쥐는 민첩이 높아 맞추기 어렵지만, 공격력이 약함**
